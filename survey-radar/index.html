<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Estrategia Tecnol贸gica - Facilitador</title>

    <!-- Fonts -->
    <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=clash-display@400,500,600,700&f[]=space-grotesk@300,400,500,600,700&display=swap">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <style>
        :root {
            --bg: #0a0a0f;
            --bg-surface: #12121a;
            --bg-card: #1a1a24;
            --text: #e8e6e3;
            --text-secondary: #9090a0;
            --muted: #6b6b78;
            --cyan: #00e5ff;
            --magenta: #ff0080;
            --purple: #8b5cf6;
            --green: #10b981;
            --cyan-glow: rgba(0, 229, 255, 0.4);
            --font-display: 'Clash Display', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }

        /* Grid background */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(0, 229, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 229, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header h1 span {
            background: linear-gradient(135deg, var(--cyan), var(--magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-bottom: 2rem;
            padding: 1rem 2rem;
            background: var(--bg-surface);
            border-radius: 12px;
            border: 1px solid rgba(0, 229, 255, 0.1);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--cyan);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Main grid */
        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr 350px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* QR Section */
        .qr-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .qr-section h2 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--cyan);
        }

        #qr-code {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 1rem;
        }

        #qr-code canvas {
            display: block;
        }

        .qr-url {
            font-size: 0.75rem;
            color: var(--muted);
            word-break: break-all;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            width: 100%;
        }

        .btn-primary {
            background: var(--cyan);
            color: var(--bg);
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px var(--cyan-glow);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 0.5rem;
        }

        .btn-secondary:hover {
            border-color: var(--magenta);
            color: var(--magenta);
        }

        /* Radar Section */
        .radar-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .radar-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1;
        }

        #radar-svg {
            width: 100%;
            height: 100%;
        }

        /* Results Section */
        .results-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .results-section h2 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--cyan);
        }

        .dimension-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dimension-row:last-child {
            border-bottom: none;
        }

        .dimension-name {
            width: 120px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .dimension-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .dimension-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--purple));
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        .dimension-value {
            width: 50px;
            text-align: right;
            font-family: var(--font-display);
            font-weight: 600;
            color: var(--cyan);
        }

        /* Status indicator */
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.5rem;
            padding: 0.75rem;
            background: rgba(0, 229, 255, 0.1);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Waiting state */
        .waiting-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
        }

        .waiting-message .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Setup notice */
        .setup-notice {
            background: rgba(255, 0, 128, 0.1);
            border: 1px solid rgba(255, 0, 128, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .setup-notice h3 {
            color: var(--magenta);
            margin-bottom: 0.5rem;
        }

        .setup-notice code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Notice (shown when Firebase not configured) -->
        <div class="setup-notice" id="setup-notice" style="display: none;">
            <h3>Configuraci贸n requerida</h3>
            <p>Para activar el modo en tiempo real, configura Firebase en el c贸digo.</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                Busca <code>firebaseConfig</code> en el c贸digo y agrega tus credenciales.
            </p>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>Radar de <span>Estrategia Tecnol贸gica</span></h1>
            <p>Escanea el QR para participar - Resultados en tiempo real</p>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="participant-count">0</div>
                <div class="stat-label">Participantes</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="avg-score">-</div>
                <div class="stat-label">Promedio General</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="session-id">-</div>
                <div class="stat-label">Sesi贸n</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- QR Section -->
            <div class="qr-section">
                <h2>Escanea para participar</h2>
                <div id="qr-code"></div>
                <div class="qr-url" id="survey-url"></div>
                <button class="btn btn-primary" onclick="copyUrl()">
                    Copiar enlace
                </button>
                <button class="btn btn-secondary" onclick="newSession()">
                    Nueva sesi贸n
                </button>
            </div>

            <!-- Radar Section -->
            <div class="radar-section">
                <div class="radar-container">
                    <svg id="radar-svg" viewBox="-220 -200 440 400">
                        <!-- Background hexagon grid -->
                        <g class="radar-grid" stroke="rgba(0, 229, 255, 0.15)" fill="none">
                            <!-- Level circles -->
                            <polygon id="grid-1" stroke-dasharray="4,4" />
                            <polygon id="grid-2" stroke-dasharray="4,4" />
                            <polygon id="grid-3" stroke-dasharray="4,4" />
                            <polygon id="grid-4" stroke-dasharray="4,4" />
                            <polygon id="grid-5" />
                            <!-- Axis lines -->
                            <g id="axis-lines"></g>
                        </g>

                        <!-- Data polygon -->
                        <polygon id="data-polygon"
                            fill="rgba(0, 229, 255, 0.2)"
                            stroke="#00e5ff"
                            stroke-width="2"
                            filter="url(#glow)" />

                        <!-- Data points -->
                        <g id="data-points"></g>

                        <!-- Labels -->
                        <g id="axis-labels" font-family="Space Grotesk" font-size="14" font-weight="600" fill="#e8e6e3"></g>

                        <!-- Glow filter -->
                        <defs>
                            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                    </svg>
                </div>

                <div class="status">
                    <div class="status-dot"></div>
                    <span>Actualizando en tiempo real</span>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <h2>Resultados por dimensi贸n</h2>
                <div id="dimension-results">
                    <div class="waiting-message">
                        <div class="icon"></div>
                        <p>Esperando respuestas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // CONFIGURACIN DE FIREBASE
        // =====================================================
        // Para activar el modo en tiempo real:
        // 1. Ve a https://console.firebase.google.com
        // 2. Crea un proyecto nuevo (o usa uno existente)
        // 3. Activa Realtime Database
        // 4. En las reglas, pon: { "rules": { ".read": true, ".write": true } }
        // 5. Copia tu configuraci贸n aqu铆:

        const firebaseConfig = {
            apiKey: "AIzaSyB55yzZqyYRLLPnS3XJRo9EKRM_OSr1-Ew",
            authDomain: "techradar-da04d.firebaseapp.com",
            databaseURL: "https://techradar-da04d-default-rtdb.firebaseio.com",
            projectId: "techradar-da04d",
            storageBucket: "techradar-da04d.firebasestorage.app",
            messagingSenderId: "923225198073",
            appId: "1:923225198073:web:b2104a26c40e768d01c128"
        };

        // =====================================================
        // CONFIGURACIN DEL RADAR
        // =====================================================
        const dimensions = [
            { id: 'infraestructura', label: 'Infraestructura', angle: -90 },
            { id: 'arquitectura', label: 'Arquitectura', angle: -30 },
            { id: 'datos', label: 'Datos', angle: 30 },
            { id: 'seguridad', label: 'Seguridad', angle: 90 },
            { id: 'talento', label: 'Talento', angle: 150 },
            { id: 'innovacion', label: 'Innovaci贸n', angle: 210 }
        ];

        const maxRadius = 120;
        let db = null;
        let sessionId = '';
        let isFirebaseConfigured = false;

        // =====================================================
        // INICIALIZACIN
        // =====================================================
        function init() {
            // Check if Firebase is configured
            isFirebaseConfigured = firebaseConfig.apiKey !== "TU_API_KEY";

            if (isFirebaseConfigured) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                } catch (e) {
                    console.error('Firebase init error:', e);
                    isFirebaseConfigured = false;
                }
            }

            if (!isFirebaseConfigured) {
                document.getElementById('setup-notice').style.display = 'block';
                // Use demo mode
                startDemoMode();
            }

            // Generate or get session ID
            sessionId = getSessionId();
            document.getElementById('session-id').textContent = sessionId.split('-')[1].substring(0, 6).toUpperCase();

            // Draw radar grid
            drawRadarGrid();

            // Generate QR code
            generateQR();

            // Start listening for responses
            if (isFirebaseConfigured) {
                listenForResponses();
            }
        }

        function getSessionId() {
            let id = sessionStorage.getItem('radar-session-id');
            if (!id) {
                id = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('radar-session-id', id);
            }
            return id;
        }

        function newSession() {
            sessionStorage.removeItem('radar-session-id');
            location.reload();
        }

        // =====================================================
        // QR CODE
        // =====================================================
        function generateQR() {
            const baseUrl = window.location.href.replace('index.html', '').replace(/\/$/, '');
            const surveyUrl = `${baseUrl}/participante.html?session=${sessionId}`;

            document.getElementById('survey-url').textContent = surveyUrl;

            QRCode.toCanvas(document.createElement('canvas'), surveyUrl, {
                width: 200,
                margin: 0,
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, function(error, canvas) {
                if (error) {
                    console.error(error);
                    return;
                }
                document.getElementById('qr-code').innerHTML = '';
                document.getElementById('qr-code').appendChild(canvas);
            });
        }

        function copyUrl() {
            const url = document.getElementById('survey-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '隆Copiado!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        }

        // =====================================================
        // RADAR DRAWING
        // =====================================================
        function drawRadarGrid() {
            // Draw level polygons
            for (let level = 1; level <= 5; level++) {
                const points = dimensions.map(d => {
                    const r = (level / 5) * maxRadius;
                    return getPoint(d.angle, r);
                }).map(p => `${p.x},${p.y}`).join(' ');
                document.getElementById(`grid-${level}`).setAttribute('points', points);
            }

            // Draw axis lines
            const axisLines = document.getElementById('axis-lines');
            axisLines.innerHTML = dimensions.map(d => {
                const p = getPoint(d.angle, maxRadius);
                return `<line x1="0" y1="0" x2="${p.x}" y2="${p.y}" />`;
            }).join('');

            // Draw labels
            const labels = document.getElementById('axis-labels');
            labels.innerHTML = dimensions.map(d => {
                const p = getPoint(d.angle, maxRadius + 35);
                const anchor = d.angle === -90 || d.angle === 90 ? 'middle' :
                              d.angle > 90 || d.angle < -90 ? 'end' : 'start';
                return `<text x="${p.x}" y="${p.y}" text-anchor="${anchor}" dominant-baseline="middle">${d.label}</text>`;
            }).join('');

            // Initialize with zero values
            updateRadar({
                infraestructura: 0,
                arquitectura: 0,
                datos: 0,
                seguridad: 0,
                talento: 0,
                innovacion: 0
            });
        }

        function getPoint(angleDeg, radius) {
            const angleRad = (angleDeg * Math.PI) / 180;
            return {
                x: Math.cos(angleRad) * radius,
                y: Math.sin(angleRad) * radius
            };
        }

        function updateRadar(averages) {
            // Update polygon
            const points = dimensions.map(d => {
                const value = averages[d.id] || 0;
                const r = (value / 5) * maxRadius;
                return getPoint(d.angle, r);
            }).map(p => `${p.x},${p.y}`).join(' ');

            document.getElementById('data-polygon').setAttribute('points', points);

            // Update data points
            const dataPoints = document.getElementById('data-points');
            dataPoints.innerHTML = dimensions.map(d => {
                const value = averages[d.id] || 0;
                const r = (value / 5) * maxRadius;
                const p = getPoint(d.angle, r);
                return `<circle cx="${p.x}" cy="${p.y}" r="5" fill="#00e5ff" filter="url(#glow)" />`;
            }).join('');

            // Update dimension results
            updateDimensionResults(averages);
        }

        function updateDimensionResults(averages) {
            const container = document.getElementById('dimension-results');
            const hasData = Object.values(averages).some(v => v > 0);

            if (!hasData) {
                container.innerHTML = `
                    <div class="waiting-message">
                        <div class="icon"></div>
                        <p>Esperando respuestas...</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = dimensions.map(d => {
                const value = averages[d.id] || 0;
                const percentage = (value / 5) * 100;
                return `
                    <div class="dimension-row">
                        <div class="dimension-name">${d.label}</div>
                        <div class="dimension-bar">
                            <div class="dimension-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="dimension-value">${value.toFixed(1)}</div>
                    </div>
                `;
            }).join('');
        }

        // =====================================================
        // FIREBASE LISTENERS
        // =====================================================
        function listenForResponses() {
            if (!db) return;

            const responsesRef = db.ref(`radar-sessions/${sessionId}/responses`);

            responsesRef.on('value', (snapshot) => {
                const responses = snapshot.val();
                if (!responses) {
                    document.getElementById('participant-count').textContent = '0';
                    document.getElementById('avg-score').textContent = '-';
                    return;
                }

                const responseArray = Object.values(responses);
                const count = responseArray.length;

                document.getElementById('participant-count').textContent = count;

                // Calculate averages
                const averages = {};
                dimensions.forEach(d => {
                    const sum = responseArray.reduce((acc, r) => acc + (r[d.id] || 0), 0);
                    averages[d.id] = sum / count;
                });

                // Calculate overall average
                const overallAvg = Object.values(averages).reduce((a, b) => a + b, 0) / dimensions.length;
                document.getElementById('avg-score').textContent = overallAvg.toFixed(1);

                // Update radar
                updateRadar(averages);
            });
        }

        // =====================================================
        // DEMO MODE (when Firebase not configured)
        // =====================================================
        function startDemoMode() {
            let demoResponses = [];

            // Add a demo response every 3 seconds
            const addDemoResponse = () => {
                const response = {};
                dimensions.forEach(d => {
                    response[d.id] = Math.floor(Math.random() * 5) + 1;
                });
                demoResponses.push(response);

                const count = demoResponses.length;
                document.getElementById('participant-count').textContent = count;

                // Calculate averages
                const averages = {};
                dimensions.forEach(d => {
                    const sum = demoResponses.reduce((acc, r) => acc + r[d.id], 0);
                    averages[d.id] = sum / count;
                });

                const overallAvg = Object.values(averages).reduce((a, b) => a + b, 0) / dimensions.length;
                document.getElementById('avg-score').textContent = overallAvg.toFixed(1);

                updateRadar(averages);
            };

            // Start demo after 2 seconds, then every 3 seconds
            setTimeout(() => {
                addDemoResponse();
                setInterval(addDemoResponse, 3000);
            }, 2000);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
